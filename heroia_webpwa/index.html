<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HERO.IA Copiloto</title>
  <link rel="icon" href="assets/img/icon128.png" sizes="128x128" />
  <link rel="apple-touch-icon" href="assets/img/icon192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="assets/img/icon128.png" sizes="128x128" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <main class="app">
    <header>
      <h1>HERO.IA </h1>
      <p>Analisa a conversa e sugere a melhor resposta.</p>
      <div class="license-pill" id="license-pill">Licença não validada</div>
    </header>

    <section class="license-card">
      <div class="license-head">
        <div>
          <p class="eyebrow">Ativação obrigatória</p>
          <h2>Valide sua licença</h2>
          <p class="muted">Informe a licença e e-mail. O backend valida tudo direto no Supabase.</p>
        </div>
        <div class="device-box">
          <span>ID do dispositivo</span>
          <code id="device-id"></code>
          <button class="ghost" id="copy-device" type="button">Copiar</button>
        </div>
      </div>
      <form id="license-form" class="license-form">
        <label>
          <span>License key</span>
          <input id="license-key" name="license_key" placeholder="LIC-XXXX-XXXX" required />
        </label>
        <label>
          <span>E-mail</span>
          <input id="license-email" name="email" type="email" placeholder="voce@empresa.com" required />
        </label>
        <div class="license-actions">
          <button id="btn-activate" type="submit">Ativar / Validar licença</button>
          <p id="license-status" class="status muted">Informe os dados e ative para liberar o uso.</p>
        </div>
      </form>
    </section>

    <section class="inputs">
      <textarea id="messages" placeholder="Cole aqui as mensagens (autor: texto)" rows="8"></textarea>
      <div class="actions">
        <button id="btn-draft">✍️ HERO.IA Gerar Rascunho...</button>
        <button id="btn-copilot">🧠 HERO.IA Copiloto/Follow-Up</button>
        <button id="btn-refine">📝 Refinar TXT</button>
        <button id="btn-credito">💰 Crédito</button>
        <button id="btn-clear">Limpar</button>
      </div>
    </section>

    <section class="output">
      <div class="panel">
        <h3>🧠 HERO.IA Análise</h3>
        <pre id="analysis"></pre>
      </div>
      <div class="panel">
        <h3>Sugestão</h3>
        <pre id="suggestion"></pre>
        <div class="actions">
          <button id="btn-copy">Copiar</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = "https://heroia-full-nuven-1.onrender.com";
    const DEVICE_ID_KEY = "heroia_device_id";
    const ACTIVATION_KEY = "heroia_activation_v2";

    const messagesEl = document.getElementById("messages");
    const analysisEl = document.getElementById("analysis");
    const suggestionEl = document.getElementById("suggestion");
    const btnCopilot = document.getElementById("btn-copilot");
    const btnDraft = document.getElementById("btn-draft");
    const btnRefine = document.getElementById("btn-refine");
    const btnCredito = document.getElementById("btn-credito");
    const btnCopy = document.getElementById("btn-copy");
    const btnClear = document.getElementById("btn-clear");
    let creditoPrompted = false;

    const deviceIdEl = document.getElementById("device-id");
    const copyDeviceBtn = document.getElementById("copy-device");
    const licenseForm = document.getElementById("license-form");
    const licenseKeyInput = document.getElementById("license-key");
    const licenseEmailInput = document.getElementById("license-email");
    const licenseStatusEl = document.getElementById("license-status");
    const licensePill = document.getElementById("license-pill");
    const btnActivate = document.getElementById("btn-activate");

    const maskKeyView = (key = "") => {
      const clean = String(key || "").trim();
      if (clean.length <= 8) return clean;
      return `${clean.slice(0, 4)}******${clean.slice(-4)}`;
    };

    function generateDeviceId() {
      if (crypto?.randomUUID) return crypto.randomUUID();
      return `dev-${Date.now()}-${Math.random().toString(16).slice(2, 10)}`;
    }

    function getDeviceId() {
      const existing = localStorage.getItem(DEVICE_ID_KEY);
      if (existing) return existing;
      const created = generateDeviceId();
      localStorage.setItem(DEVICE_ID_KEY, created);
      return created;
    }

    const DEVICE_ID = getDeviceId();
    deviceIdEl.textContent = DEVICE_ID;

    function loadActivation() {
      try {
        const raw = localStorage.getItem(ACTIVATION_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch (err) {
        console.warn("Falha ao ler ativação local", err);
        return null;
      }
    }

    function saveActivation(data) {
      localStorage.setItem(ACTIVATION_KEY, JSON.stringify(data));
    }

    function renderActivation(state, message) {
      const status = state?.status || "pending";
      const expires = state?.expires_at || state?.expiresAt || null;

      let text = "Licença não validada";
      let pillClass = "license-pill";
      if (status === "active") {
        text = "Licença válida" + (expires ? ` • expira em ${new Date(expires).toLocaleDateString()}` : "");
        pillClass += " success";
      } else if (status === "blocked") {
        text = "Licença bloqueada";
        pillClass += " danger";
      } else if (status === "error") {
        text = "Erro de licença";
        pillClass += " danger";
      }

      licensePill.textContent = text;
      licensePill.className = pillClass;
      licenseStatusEl.textContent = message || text;
    }

    function requireActiveLicense() {
      const state = loadActivation();
      if (!state || state.status !== "active") {
        throw new Error("Ative sua licença para usar o HERO.IA.");
      }
      return state;
    }

    async function activateLicense(event) {
      event.preventDefault();
      const inputKey = licenseKeyInput.value.trim();
      const license_key = (inputKey.includes("â€¢") || inputKey.includes("*")) && licenseKeyInput.dataset.rawKey
        ? licenseKeyInput.dataset.rawKey
        : inputKey;
      const email = licenseEmailInput.value.trim();
      if (!license_key || !email) {
        renderActivation({ status: "error" }, "Preencha license key e e-mail.");
        return;
      }

      btnActivate.disabled = true;
      const originalLabel = btnActivate.textContent;
      btnActivate.textContent = "Validando...";

      try {
        const res = await fetch(`${API_BASE}/api/license/activate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ license_key, email, device_id: DEVICE_ID, notes: "PWA", source: "PWA" })
        });

        const payload = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(payload.error || `Erro ${res.status}`);

        const state = {
          license_key,
          email,
          device_id: DEVICE_ID,
          status: payload.status,
          expires_at: payload.expires_at || null
        };
        saveActivation(state);
        licenseKeyInput.dataset.rawKey = license_key;
        licenseKeyInput.value = maskKeyView(license_key);
        renderActivation(state, "Licença ativada neste dispositivo.");
      } catch (err) {
        console.error("Ativação falhou", err);
        renderActivation({ status: "error" }, err.message || "Erro ao ativar");
      } finally {
        btnActivate.disabled = false;
        btnActivate.textContent = originalLabel;
      }
    }

    function parseMessagesForCopilot(raw) {
      return raw
        .split(/\n+/)
        .map((line) => line.trim())
        .filter(Boolean)
        .map((line) => {
          if (line.includes(":")) {
            const [author, ...rest] = line.split(":");
            const text = rest.join(":").trim();
            if (author && text) return { author: author.trim(), text };
          }
          return { author: "cliente", text: line };
        });
    }

    function parseMessagesForDraft(raw) {
      return raw
        .split(/\n+/)
        .map((line) => line.trim())
        .filter(Boolean);
    }

    function formatarBRL(valor) {
      return new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL", maximumFractionDigits: 2 }).format(valor);
    }

        function normalizarNumero(texto) {
      if (!texto) return null;
      const lower = texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
      const numeroMatch = lower.match(/(\d[\d.,]*)/);
      if (!numeroMatch) return null;
      let numerico = numeroMatch[1];
      let multiplicador = 1;
      if (/(^|\s)milhao(s)?(\s|$)/.test(lower) || /(milh[ao]es)/.test(lower)) multiplicador = 1000000;
      else if (/(^|\s)mil(\s|$)/.test(lower)) multiplicador = 1000;
      numerico = numerico.replace(/\./g, "");
      if (numerico.includes(",")) {
        const partes = numerico.split(",");
        numerico = `${partes.slice(0, -1).join("")}.${partes.slice(-1)}`;
      }
      const valor = parseFloat(numerico) * multiplicador;
      return Number.isFinite(valor) ? valor : null;
    }

    function extrairDadosCredito(conversa) {
      const linhas = conversa.split(/\n/);
      const dados = { valor: null, entrada: null, fgts: 0, renda: null, prazo: null, sistema: "PRICE", hasSac: false, hasPrice: false };
      linhas.forEach((linhaRaw) => {
        if (!linhaRaw) return;
        if (/^\s*\[?\d{1,2}:\d{2}/.test(linhaRaw)) return;
        const linha = linhaRaw.trim();
        const lower = linha.toLowerCase();
        const entradaKeywords = ["entrada", "cash", "sinal", "entrada disponivel", "disponivel para entrada", "disponível para entrada"];
        if (/im[oó]vel/.test(lower)) dados.valor = normalizarNumero(linha) ?? dados.valor;
        if (entradaKeywords.some((k) => lower.includes(k))) dados.entrada = normalizarNumero(linha) ?? dados.entrada;
        if (lower.includes("fgts")) {
          const fgts = normalizarNumero(linha);
          if (fgts !== null) dados.fgts = fgts;
        }
        if (lower.includes("renda")) dados.renda = normalizarNumero(linha) ?? dados.renda;
        if (lower.includes("prazo")) dados.prazo = normalizarNumero(linha) ?? dados.prazo;
        if (lower.includes("sac")) { dados.sistema = "SAC"; dados.hasSac = true; }
        if (lower.includes("price")) { dados.sistema = "PRICE"; dados.hasPrice = true; }
      });
      if (dados.entrada === null) dados.entrada = 0;
      if (dados.fgts === null) dados.fgts = 0;
      if (dados.prazo !== null && dados.prazo > 100) {
        dados.prazo = Math.round(dados.prazo / 12);
      }
      return dados;
    }
    function calcularPrice(pv, taxaAnual, meses) {
      const i = taxaAnual / 12;
      return pv * ((i * Math.pow(1 + i, meses)) / (Math.pow(1 + i, meses) - 1));
    }

    function calcularSAC(pv, taxaAnual, meses) {
      const i = taxaAnual / 12;
      const amortizacao = pv / meses;
      const primeira = amortizacao + (pv * i);
      const saldoFinal = amortizacao;
      const ultima = amortizacao + (saldoFinal * i);
      return { primeira, ultima };
    }

    function parcelaMaxima(renda) { return renda * 0.3; }

    function encontrarPrazoIdeal(pv, renda, taxaAnual, sistema) {
      const limite = parcelaMaxima(renda);
      for (let anos = 10; anos <= 35; anos++) {
        const meses = anos * 12;
        const taxaMensal = taxaAnual / 12;
        const parcela = sistema === "SAC"
          ? (pv / meses) + (pv * taxaMensal)
          : calcularPrice(pv, taxaAnual, meses);
        if (parcela <= limite) return { anos, parcela };
      }
      return null;
    }

    function montarMensagemSolicitacao() {
      return `💰 Vamos simular seu potencial de compra?

Envie:

• Valor do imóvel
• Valor disponível para Entrada
• Valor disponível FGTS
• Renda bruta mensal
• Prazo (anos) Desejado
• Idade do titular (e do cônjuge, se houver)
• Sistema: SAC ou PRICE`;
    }

    function montarResumoDados(dados, sistemas) {
      const listaSistemas = sistemas.join(" / ");
      return [
        "Dados do solicitante :",
        "",
        `• Valor do imóvel: ${formatarBRL(dados.valor)}`,
        `• Valor disponível para Entrada: ${formatarBRL(dados.entrada)}`,
        `• Valor disponível FGTS: ${formatarBRL(dados.fgts || 0)}`,
        `• Renda bruta mensal: ${formatarBRL(dados.renda)}`,
        `• Prazo (anos) Desejado: ${dados.prazo} anos`,
        `• Sistemas solicitados: ${listaSistemas}`
      ].join("\n");
    }

    function montarBlocoSistema(sistema, parcela, comprometimento, financiado, ajuste, primeiraParcela, ultimaParcela, taxaAnual) {
      let mensagem = `Valores da Simulação (${sistema}):

Valor financiado: ${formatarBRL(financiado)}
Taxa considerada: ${(taxaAnual * 100).toFixed(2)}% a.a.
Parcela: ${formatarBRL(parcela)}
1ª parcela estimada: ${formatarBRL(primeiraParcela)}
Última parcela estimada: ${formatarBRL(ultimaParcela)}
Comprometimento: ${comprometimento.toFixed(1)}%`;

      if (ajuste) {
        mensagem += `

📌 Ajuste Estratégico (auto)
Prazo ideal: ${ajuste.anos} anos
Nova parcela: ${formatarBRL(ajuste.parcela)}`;
      }
      return mensagem;
    }

    const CHECKLIST_CREDITO = `💰 Vamos simular seu potencial de compra?

Envie os DADOS abaixo e clique novamente no Botão Crédito:

• Valor do imóvel
• Valor disponível para Entrada
• Valor disponível FGTS
• Renda bruta mensal
• Prazo (anos) Desejado
• Idade do titular (e do cônjuge, se houver)
• Sistema: SAC ou PRICE`;

        async function runCredito() {
      const TAXA_ANUAL = 0.095;
      toggleLoading(true, btnCredito);
      try {
        if (!creditoPrompted) {
          suggestionEl.textContent = CHECKLIST_CREDITO;
          analysisEl.textContent = "Envie os dados acima e clique novamente em Credito.";
          creditoPrompted = true;
          return;
        }

        requireActiveLicense();
        const conversa = messagesEl.value.trim();
        if (!conversa) {
          suggestionEl.textContent = CHECKLIST_CREDITO;
          analysisEl.textContent = "Aguardando dados para simulacao.";
          return;
        }

        const dados = extrairDadosCredito(conversa);
        const camposOk = dados.valor !== null && dados.renda !== null && dados.prazo !== null;
        if (!camposOk) {
          suggestionEl.textContent = CHECKLIST_CREDITO;
          analysisEl.textContent = "Dados incompletos - envie os dados e clique novamente em Credito.";
          return;
        }

        const financiado = Math.max(0, (dados.valor || 0) - (dados.entrada || 0) - (dados.fgts || 0));
        const meses = (dados.prazo || 0) * 12;
        if (!financiado || financiado <= 0 || !meses || meses <= 0) {
          suggestionEl.textContent = CHECKLIST_CREDITO;
          analysisEl.textContent = "Valores invalidos - ajuste os dados e clique novamente.";
          return;
        }

        const sistemas = [];
        if (dados.hasSac) sistemas.push("SAC");
        if (dados.hasPrice) sistemas.push("PRICE");
        if (sistemas.length === 0) sistemas.push(dados.sistema || "PRICE");

        const mensagens = sistemas.map((sistema) => {
          const base = sistema === "SAC"
            ? calcularSAC(financiado, TAXA_ANUAL, meses)
            : { primeira: calcularPrice(financiado, TAXA_ANUAL, meses), ultima: calcularPrice(financiado, TAXA_ANUAL, meses) };

          const primeiraParcela = base.primeira;
          const ultimaParcela = base.ultima;
          const parcela = primeiraParcela;
          const comprometimento = (parcela / (dados.renda || 1)) * 100;
          const precisaAjuste = parcela > parcelaMaxima(dados.renda || 0);
          const ajuste = precisaAjuste ? encontrarPrazoIdeal(financiado, dados.renda, TAXA_ANUAL, sistema) : null;

          return montarBlocoSistema(
            sistema,
            ajuste ? ajuste.parcela : parcela,
            ajuste ? (ajuste.parcela / dados.renda) * 100 : comprometimento,
            financiado,
            ajuste,
            primeiraParcela,
            ultimaParcela,
            TAXA_ANUAL
          );
        });

        const cabecalho = "💰 Simulação estimada";
        const resumo = montarResumoDados(dados, sistemas);
        const corpo = mensagens.join("\n\n");
        const aviso = "⚠️ Estimativa sujeita à análise do banco. Taxas e CET podem variar.";

        const finalTexto = `${cabecalho}

${resumo}

${corpo}

${aviso}`;
        suggestionEl.textContent = finalTexto;
        analysisEl.textContent = "Simulação gerada com base na conversa.";
      } catch (err) {
        analysisEl.textContent = "Erro ao gerar simulação de crédito";
        renderActivation({ status: "error" }, err.message);
        console.error(err);
      } finally {
        toggleLoading(false, btnCredito);
      }
    }
    function buildRewriteInsights(text = "") {
      const t = (text || "").toLowerCase();
      const bullets = [];
      if (t.includes("fgts") || t.includes("financi")) bullets.push("Mostra claramente como usar FGTS e financiar sem surpresa.");
      if (t.includes("parcela") || t.includes("prest")) bullets.push("Entrega a parcela exata e o teto de compra, reduzindo insegurança.");
      if (t.includes("document")) bullets.push("Lista documentos e passa seriedade no processo.");
      if (t.includes("seguran") || t.includes("tranqui")) bullets.push("Reforça segurança e tranquilidade na decisão.");
      if (!bullets.length) bullets.push("Texto lapidado para ficar claro, consultivo e sem pressão.");
      return [
        "Insights do texto lapidado:",
        ...bullets.map((b) => `- ${b}`),
        "Pronto para colar no WhatsApp."
      ].join("\n");
    }

    async function call(path, payload) {
      const activation = requireActiveLicense();
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-license-key": activation.license_key,
          "x-device-id": activation.device_id || DEVICE_ID
        },
        body: JSON.stringify(payload)
      });

      const body = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(body.error || `API error ${res.status}`);
      return body;
    }

    async function runCopilot() {
      toggleLoading(true, btnCopilot);
      try {
        requireActiveLicense();
        const messageText = messagesEl.value.trim();
        const messages = parseMessagesForCopilot(messageText);
        if (!messages.length || !messageText) {
          alert("Cole mensagens do cliente antes de rodar o Copiloto.");
          return;
        }
        const res = await call("/whatsapp/copilot", { messages });
        const analysis = res.analysis || "";
        analysisEl.textContent = analysis ? `${analysis}\n\nâœï¸ FollowUp sugerido GERADO ðŸ‘‰` : "";
        suggestionEl.textContent = res.suggestion || res.draft || "";
      } catch (err) {
        analysisEl.textContent = "Erro ao rodar Copiloto";
        renderActivation({ status: "error" }, err.message);
        console.error(err);
      } finally {
        toggleLoading(false, btnCopilot);
      }
    }

    async function runDraft() {
      toggleLoading(true, btnDraft);
      try {
        requireActiveLicense();
        const message = messagesEl.value.trim();
        if (!message) {
          alert("Cole mensagens do cliente antes de gerar o rascunho.");
          return;
        }
        const res = await call("/whatsapp/draft", { message });
        const analysis = res.analysis || "";
        analysisEl.textContent = analysis ? `${analysis}\n\nâœï¸ FollowUp sugerido GERADO ðŸ‘‰` : "";
        suggestionEl.textContent = res.suggestion || res.draft || "";
      } catch (err) {
        analysisEl.textContent = "Erro ao gerar rascunho";
        renderActivation({ status: "error" }, err.message);
        console.error(err);
      } finally {
        toggleLoading(false, btnDraft);
      }
    }

    async function runRefine() {
      toggleLoading(true, btnRefine);
      try {
        requireActiveLicense();
        const message = messagesEl.value.trim();
        if (!message) {
          alert("Digite ou cole um texto antes de refinar.");
          return;
        }
        const res = await call("/whatsapp/refine", { mensagem: message });
        const refined = res.refined?.trim() || message;
        suggestionEl.textContent = refined;
        const analysis = res.analysis || buildRewriteInsights(refined);
        analysisEl.textContent = analysis;
      } catch (err) {
        analysisEl.textContent = "Erro ao refinar";
        renderActivation({ status: "error" }, err.message);
        console.error(err);
      } finally {
        toggleLoading(false, btnRefine);
      }
    }

    function toggleLoading(isLoading, btn) {
      if (!btn) return;
      btn.disabled = isLoading;
      if (isLoading) {
        if (btn.id === "btn-draft") btn.textContent = "✍️ HERO.IA - Gerando...";
        else if (btn.id === "btn-copilot") btn.textContent = "🧠 HERO.IA - Analisando...";
        else if (btn.id === "btn-refine") btn.textContent = "📝 Refinando...";
        else if (btn.id === "btn-credito") btn.textContent = "Simulando...";
        else btn.textContent = "Carregando...";
      } else {
        btn.textContent = btn.dataset.label || btn.textContent;
      }
    }

    btnCopilot.dataset.label = btnCopilot.textContent;
    btnDraft.dataset.label = btnDraft.textContent;
    btnRefine.dataset.label = btnRefine.textContent;
    btnCredito.dataset.label = btnCredito.textContent;

    const existing = loadActivation();
    if (existing) {
      licenseKeyInput.dataset.rawKey = existing.license_key || "";
      licenseKeyInput.value = maskKeyView(existing.license_key || "");
      licenseEmailInput.value = existing.email || "";
      if (!existing.device_id) {
        const updated = { ...existing, device_id: DEVICE_ID };
        saveActivation(updated);
      }
      renderActivation(existing);
    }

    licenseForm.addEventListener("submit", activateLicense);
    copyDeviceBtn.addEventListener("click", () => {
      navigator.clipboard?.writeText(DEVICE_ID).then(() => {
        renderActivation(loadActivation(), "Device ID copiado.");
      }).catch(() => renderActivation(loadActivation(), "Copie manualmente: " + DEVICE_ID));
    });

    btnCopilot.addEventListener("click", runCopilot);
    btnDraft.addEventListener("click", runDraft);
    btnRefine.addEventListener("click", runRefine);
    btnCredito.addEventListener("click", runCredito);
    btnCopy.addEventListener("click", () => {
      const text = suggestionEl.textContent || "";
      navigator.clipboard?.writeText(text).catch(() => {});
    });
    btnClear.addEventListener("click", () => {
      messagesEl.value = "";
      analysisEl.textContent = "";
      suggestionEl.textContent = "";
    });
  </script>
</body>
</html>












