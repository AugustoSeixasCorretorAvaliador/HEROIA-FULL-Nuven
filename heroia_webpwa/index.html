<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HERO.IA Copiloto</title>
  <link rel="icon" href="assets/img/icon128.png" sizes="128x128" />
  <link rel="apple-touch-icon" href="assets/img/icon192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="assets/img/icon128.png" sizes="128x128" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <main class="app">
    <header>
      <h1>HERO.IA </h1>
      <p>Analisa a conversa e sugere a melhor resposta.</p>
      <div class="license-pill" id="license-pill">Licen√ßa n√£o validada</div>
    </header>

    <section class="license-card">
      <div class="license-head">
        <div>
          <p class="eyebrow">Ativa√ß√£o obrigat√≥ria</p>
          <h2>Valide sua licen√ßa</h2>
          <p class="muted">Informe a licen√ßa e e-mail. O backend valida tudo direto no Supabase.</p>
        </div>
        <div class="device-box">
          <span>ID do dispositivo</span>
          <code id="device-id"></code>
          <button class="ghost" id="copy-device" type="button">Copiar</button>
        </div>
      </div>
      <form id="license-form" class="license-form">
        <label>
          <span>License key</span>
          <input id="license-key" name="license_key" placeholder="LIC-XXXX-XXXX" required />
        </label>
        <label>
          <span>E-mail</span>
          <input id="license-email" name="email" type="email" placeholder="voce@empresa.com" required />
        </label>
        <div class="license-actions">
          <button id="btn-activate" type="submit">Ativar / Validar licen√ßa</button>
          <p id="license-status" class="status muted">Informe os dados e ative para liberar o uso.</p>
        </div>
      </form>
    </section>

    <section class="inputs">
      <textarea id="messages" placeholder="Cole aqui as mensagens (autor: texto)" rows="8"></textarea>
      <div class="actions">
        <button id="btn-draft">‚úçÔ∏è HERO.IA Gerar Rascunho...</button>
        <button id="btn-copilot">üß† HERO.IA Copiloto/Follow-Up</button>
        <button id="btn-clear">Limpar</button>
      </div>
    </section>

    <section class="output">
      <div class="panel">
        <h3>üß† HERO.IA An√°lise</h3>
        <pre id="analysis"></pre>
      </div>
      <div class="panel">
        <h3>Sugest√£o</h3>
        <pre id="suggestion"></pre>
        <div class="actions">
          <button id="btn-copy">Copiar</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = "https://heroia-full-nuven-1.onrender.com";
    const DEVICE_ID_KEY = "heroia_device_id";
    const ACTIVATION_KEY = "heroia_activation_v2";

    const messagesEl = document.getElementById("messages");
    const analysisEl = document.getElementById("analysis");
    const suggestionEl = document.getElementById("suggestion");
    const btnCopilot = document.getElementById("btn-copilot");
    const btnDraft = document.getElementById("btn-draft");
    const btnCopy = document.getElementById("btn-copy");
    const btnClear = document.getElementById("btn-clear");

    const deviceIdEl = document.getElementById("device-id");
    const copyDeviceBtn = document.getElementById("copy-device");
    const licenseForm = document.getElementById("license-form");
    const licenseKeyInput = document.getElementById("license-key");
    const licenseEmailInput = document.getElementById("license-email");
    const licenseStatusEl = document.getElementById("license-status");
    const licensePill = document.getElementById("license-pill");
    const btnActivate = document.getElementById("btn-activate");

    function generateDeviceId() {
      if (crypto?.randomUUID) return crypto.randomUUID();
      return `dev-${Date.now()}-${Math.random().toString(16).slice(2, 10)}`;
    }

    function getDeviceId() {
      const existing = localStorage.getItem(DEVICE_ID_KEY);
      if (existing) return existing;
      const created = generateDeviceId();
      localStorage.setItem(DEVICE_ID_KEY, created);
      return created;
    }

    const DEVICE_ID = getDeviceId();
    deviceIdEl.textContent = DEVICE_ID;

    function loadActivation() {
      try {
        const raw = localStorage.getItem(ACTIVATION_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch (err) {
        console.warn("Falha ao ler ativa√ß√£o local", err);
        return null;
      }
    }

    function saveActivation(data) {
      localStorage.setItem(ACTIVATION_KEY, JSON.stringify(data));
    }

    function renderActivation(state, message) {
      const status = state?.status || "pending";
      const expires = state?.expires_at || state?.expiresAt || null;

      let text = "Licen√ßa n√£o validada";
      let pillClass = "license-pill";
      if (status === "active") {
        text = "Licen√ßa v√°lida" + (expires ? ` ‚Ä¢ expira em ${new Date(expires).toLocaleDateString()}` : "");
        pillClass += " success";
      } else if (status === "blocked") {
        text = "Licen√ßa bloqueada";
        pillClass += " danger";
      } else if (status === "error") {
        text = "Erro de licen√ßa";
        pillClass += " danger";
      }

      licensePill.textContent = text;
      licensePill.className = pillClass;
      licenseStatusEl.textContent = message || text;
    }

    function requireActiveLicense() {
      const state = loadActivation();
      if (!state || state.status !== "active") {
        throw new Error("Ative sua licen√ßa para usar o HERO.IA.");
      }
      return state;
    }

    async function activateLicense(event) {
      event.preventDefault();
      const license_key = licenseKeyInput.value.trim();
      const email = licenseEmailInput.value.trim();
      if (!license_key || !email) {
        renderActivation({ status: "error" }, "Preencha license key e e-mail.");
        return;
      }

      btnActivate.disabled = true;
      const originalLabel = btnActivate.textContent;
      btnActivate.textContent = "Validando...";

      try {
        const res = await fetch(`${API_BASE}/api/license/activate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ license_key, email, device_id: DEVICE_ID, notes: "PWA", source: "PWA" })
        });

        const payload = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(payload.error || `Erro ${res.status}`);

        const state = {
          license_key,
          email,
          device_id: DEVICE_ID,
          status: payload.status,
          expires_at: payload.expires_at || null
        };
        saveActivation(state);
        renderActivation(state, "Licen√ßa ativada neste dispositivo.");
      } catch (err) {
        console.error("Ativa√ß√£o falhou", err);
        renderActivation({ status: "error" }, err.message || "Erro ao ativar");
      } finally {
        btnActivate.disabled = false;
        btnActivate.textContent = originalLabel;
      }
    }

    function parseMessagesForCopilot(raw) {
      return raw
        .split(/\n+/)
        .map((line) => line.trim())
        .filter(Boolean)
        .map((line) => {
          if (line.includes(":")) {
            const [author, ...rest] = line.split(":");
            const text = rest.join(":").trim();
            if (author && text) return { author: author.trim(), text };
          }
          return { author: "cliente", text: line };
        });
    }

    function parseMessagesForDraft(raw) {
      return raw
        .split(/\n+/)
        .map((line) => line.trim())
        .filter(Boolean);
    }

    async function call(path, payload) {
      const activation = requireActiveLicense();
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-license-key": activation.license_key,
          "x-device-id": activation.device_id || DEVICE_ID
        },
        body: JSON.stringify(payload)
      });

      const body = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(body.error || `API error ${res.status}`);
      return body;
    }

    async function runCopilot() {
      toggleLoading(true, btnCopilot);
      try {
        requireActiveLicense();
        const messageText = messagesEl.value.trim();
        const messages = parseMessagesForCopilot(messageText);
        if (!messages.length || !messageText) {
          alert("Cole mensagens do cliente antes de rodar o Copiloto.");
          return;
        }
        const res = await call("/whatsapp/copilot", { messages });
        const analysis = res.analysis || "";
        analysisEl.textContent = analysis ? `${analysis}\n\n‚úçÔ∏è FollowUp sugerido GERADO üëâ` : "";
        suggestionEl.textContent = res.suggestion || res.draft || "";
      } catch (err) {
        analysisEl.textContent = "Erro ao rodar Copiloto";
        renderActivation({ status: "error" }, err.message);
        console.error(err);
      } finally {
        toggleLoading(false, btnCopilot);
      }
    }

    async function runDraft() {
      toggleLoading(true, btnDraft);
      try {
        requireActiveLicense();
        const message = messagesEl.value.trim();
        if (!message) {
          alert("Cole mensagens do cliente antes de gerar o rascunho.");
          return;
        }
        const res = await call("/whatsapp/draft", { message });
        const analysis = res.analysis || "";
        analysisEl.textContent = analysis ? `${analysis}\n\n‚úçÔ∏è FollowUp sugerido GERADO üëâ` : "";
        suggestionEl.textContent = res.suggestion || res.draft || "";
      } catch (err) {
        analysisEl.textContent = "Erro ao gerar rascunho";
        renderActivation({ status: "error" }, err.message);
        console.error(err);
      } finally {
        toggleLoading(false, btnDraft);
      }
    }

    function toggleLoading(isLoading, btn) {
      if (!btn) return;
      btn.disabled = isLoading;
      if (isLoading) {
        if (btn.id === "btn-draft") btn.textContent = "‚úçÔ∏è HERO.IA - Gerando...";
        else if (btn.id === "btn-copilot") btn.textContent = "üß† HERO.IA - Analisando...";
        else btn.textContent = "Carregando...";
      } else {
        btn.textContent = btn.dataset.label || btn.textContent;
      }
    }

    btnCopilot.dataset.label = btnCopilot.textContent;
    btnDraft.dataset.label = btnDraft.textContent;

    const existing = loadActivation();
    if (existing) {
      licenseKeyInput.value = existing.license_key || "";
      licenseEmailInput.value = existing.email || "";
      if (!existing.device_id) {
        const updated = { ...existing, device_id: DEVICE_ID };
        saveActivation(updated);
      }
      renderActivation(existing);
    }

    licenseForm.addEventListener("submit", activateLicense);
    copyDeviceBtn.addEventListener("click", () => {
      navigator.clipboard?.writeText(DEVICE_ID).then(() => {
        renderActivation(loadActivation(), "Device ID copiado.");
      }).catch(() => renderActivation(loadActivation(), "Copie manualmente: " + DEVICE_ID));
    });

    btnCopilot.addEventListener("click", runCopilot);
    btnDraft.addEventListener("click", runDraft);
    btnCopy.addEventListener("click", () => {
      const text = suggestionEl.textContent || "";
      navigator.clipboard?.writeText(text).catch(() => {});
    });
    btnClear.addEventListener("click", () => {
      messagesEl.value = "";
      analysisEl.textContent = "";
      suggestionEl.textContent = "";
    });
  </script>
</body>
</html>
