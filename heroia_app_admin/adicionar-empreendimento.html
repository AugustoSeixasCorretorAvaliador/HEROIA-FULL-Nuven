<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0E2A47" />
  <title>HERO.IA ‚Äî Adicionar Empreendimento</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/css/img/icon128.png" sizes="128x128" />
  <link rel="icon" href="assets/css/img/icon192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="assets/css/img/icon192.png" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 24px 14px 32px;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      background: #fff;
      padding: 32px;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      margin: 0 auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12);
    }
    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: #1a202c;
    }
    .subtitle {
      color: #718096;
      margin: 0 0 24px 0;
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #2d3748;
      font-size: 14px;
    }
    input[type="text"],
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #3182ce;
      box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .checkbox-item label {
      margin: 0;
      font-weight: 400;
      cursor: pointer;
      font-size: 14px;
    }
    .entrega-container {
      display: flex;
      gap: 16px;
      align-items: flex-end;
    }
    .entrega-container > div {
      flex: 1;
    }
    .entrega-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
    }
    .entrega-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .entrega-checkbox label {
      margin: 0;
      font-weight: 400;
      cursor: pointer;
    }
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }
    .btn-primary {
      background: #3182ce;
      color: #fff;
    }
    .btn-primary:hover {
      background: #2c5aa0;
    }
    .btn-secondary {
      background: #e2e8f0;
      color: #2d3748;
    }
    .btn-secondary:hover {
      background: #cbd5e0;
    }
    .result {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      display: none;
    }
    .result.success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }
    .result.error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }
    .result.warning {
      background: #feebc8;
      color: #7c2d12;
      border: 1px solid #fbd38d;
    }
    input[type="text"]:disabled {
      background: #f7fafc;
      color: #a0aec0;
      cursor: not-allowed;
    }
    .field-info {
      font-size: 12px;
      color: #718096;
      margin-top: 4px;
    }
    /* Log de Atualiza√ß√£o */
    .log-container {
      margin-top: 24px;
      background: #1a202c;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
    }
    .log-container.active {
      display: block;
    }
    .log-header {
      color: #48bb78;
      font-weight: bold;
      border-bottom: 1px solid #2d3748;
      padding-bottom: 8px;
      margin-bottom: 12px;
    }
    .log-entry {
      color: #e2e8f0;
      margin-bottom: 4px;
      line-height: 1.6;
    }
    .log-entry.success {
      color: #48bb78;
    }
    .log-entry.error {
      color: #fc8181;
    }
    .log-entry.warning {
      color: #f6ad55;
    }
    .log-entry.info {
      color: #63b3ed;
    }
    .log-timestamp {
      color: #718096;
      margin-right: 8px;
    }
    .btn-clear-log {
      background: #2d3748;
      color: #e2e8f0;
      border: 1px solid #4a5568;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      float: right;
      margin-top: -4px;
    }
    .btn-clear-log:hover {
      background: #4a5568;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>üè¢ Adicionar Empreendimento</h1>
  <p class="subtitle">Preencha os dados do novo empreendimento</p>

  <form id="empreendimentoForm">
    <div class="form-group">
      <label for="apiBase">URL do Backend</label>
      <input type="text" id="apiBase" placeholder="https://..." />
      <p class="field-info">URL do servidor backend (deixe em branco para usar o padr√£o = https://heroia-full-nuven-1.onrender.com)</p>
    </div>

    <div class="form-group">
      <label for="nome">Nome do Empreendimento *</label>
      <input type="text" id="nome" required placeholder="Ex: Conviva Camboinhas" />
    </div>

    <div class="form-group">
      <label for="bairro">Bairro *</label>
      <input type="text" id="bairro" required placeholder="Ex: Camboinhas" />
    </div>

    <div class="form-group">
      <label>Tipologia *</label>
      <p class="field-info">Selecione uma ou mais tipologias</p>
      <div class="checkbox-group" id="tipologiaGroup">
        <div class="checkbox-item">
          <input type="checkbox" id="tip_studio" value="studio" />
          <label for="tip_studio">Studio</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="tip_1q" value="1q" />
          <label for="tip_1q">1 Quarto</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="tip_2q" value="2q" />
          <label for="tip_2q">2 Quartos</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="tip_3q" value="3q" />
          <label for="tip_3q">3 Quartos</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="tip_4q" value="4q" />
          <label for="tip_4q">4 Quartos</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="tip_cobertura" value="cobertura" />
          <label for="tip_cobertura">Cobertura</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="tip_duplex" value="duplex" />
          <label for="tip_duplex">Duplex</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="tip_loft" value="loft" />
          <label for="tip_loft">Loft</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="tip_lotes" value="lotes" />
          <label for="tip_lotes">Lotes/Terrenos</label>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Perfil *</label>
      <div class="checkbox-group" id="perfilGroup">
        <div class="checkbox-item">
          <input type="checkbox" id="perfil_moradia" value="moradia" checked />
          <label for="perfil_moradia">Moradia</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="perfil_investimento" value="investimento" checked />
          <label for="perfil_investimento">Investimento</label>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="descricao">Descri√ß√£o e Endere√ßo *</label>
      <p class="field-info">Inclua a descri√ß√£o do empreendimento e o endere√ßo completo</p>
      <textarea id="descricao" required placeholder="Ex: Conviva | Av. Prof. Florestan Fernandes, 574 | Lazer completo"></textarea>
    </div>

    <div class="form-group">
      <label>Entrega</label>
      <div class="entrega-container">
        <div>
          <input type="text" id="entregaAno" placeholder="Ex: 2026" />
        </div>
        <div class="entrega-checkbox">
          <input type="checkbox" id="entregaCheck" />
          <label for="entregaCheck">J√° entregue</label>
        </div>
      </div>
    </div>

    <button type="submit" class="btn-primary">Adicionar Empreendimento</button>
    <button type="button" class="btn-secondary" onclick="window.location.href='index.html'">Voltar</button>
  </form>

  <div class="result" id="result"></div>

  <!-- Log de Atualiza√ß√£o -->
  <div class="log-container" id="logContainer">
    <div class="log-header">
      üìã LOG DE ATUALIZA√á√ÉO - CADASTRO DE EMPREENDIMENTOS
      <button class="btn-clear-log" onclick="clearLog()">Limpar Log</button>
    </div>
    <div id="logEntries"></div>
  </div>
</div>

<script>
  // =====================================================
  // Sistema de Log
  // =====================================================
  const logContainer = document.getElementById('logContainer');
  const logEntries = document.getElementById('logEntries');

  function addLog(message, type = 'info') {
    // Mostra o container se estiver escondido
    logContainer.classList.add('active');

    // Cria timestamp
    const now = new Date();
    const timestamp = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
    
    // Cria entrada de log
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.innerHTML = `<span class="log-timestamp">${timestamp}</span>${message}`;
    
    // Adiciona ao container
    logEntries.appendChild(entry);
    
    // Scroll autom√°tico para o final
    logContainer.scrollTop = logContainer.scrollHeight;
    
    // Log no console tamb√©m
    console.log(`${timestamp} [${type.toUpperCase()}] ${message}`);
  }

  function clearLog() {
    logEntries.innerHTML = '';
    addLog('Log limpo', 'info');
  }

  // =====================================================
  // Inicializa√ß√£o
  // =====================================================
  addLog('Sistema iniciado', 'success');
  
  // Inicializa URL do backend
  const apiBaseInput = document.getElementById('apiBase');
  const DEFAULT_API_BASE = 'https://heroia-full-nuven-1.onrender.com'; // Mudado para localhost
  const storedBase = localStorage.getItem('admin_api_base') || '';
  const initialBase = (storedBase || DEFAULT_API_BASE || '').replace(/\/$/, '');
  apiBaseInput.value = initialBase;
  
  addLog(`Backend configurado: ${initialBase}`, 'info');

  // Controle do campo de entrega
  const entregaCheck = document.getElementById('entregaCheck');
  const entregaAno = document.getElementById('entregaAno');

  entregaCheck.addEventListener('change', function() {
    if (this.checked) {
      entregaAno.value = 'Entregue';
      entregaAno.disabled = true;
    } else {
      entregaAno.value = '';
      entregaAno.disabled = false;
    }
  });

  // Carrega empreendimentos existentes
  async function loadEmpreendimentos() {
    addLog('Carregando lista de empreendimentos...', 'info');
    
    // Como estamos usando o backend remoto, n√£o precisamos carregar localmente
    // O backend j√° faz a valida√ß√£o de nome duplicado
    addLog('Valida√ß√£o ser√° feita no servidor', 'info');
    return [];
  }

  // Valida se o nome j√° existe
  async function validateNome(nome) {
    const empreendimentos = await loadEmpreendimentos();
    const nomeNormalizado = nome.trim().toLowerCase();
    return !empreendimentos.some(emp => 
      emp.nome.toLowerCase() === nomeNormalizado
    );
  }

  // Mostra mensagem de resultado
  function showResult(message, type) {
    const resultDiv = document.getElementById('result');
    resultDiv.textContent = message;
    resultDiv.className = `result ${type}`;
    resultDiv.style.display = 'block';
    
    setTimeout(() => {
      resultDiv.style.display = 'none';
    }, 5000);
  }

  // Submiss√£o do formul√°rio
  document.getElementById('empreendimentoForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    addLog('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'info');
    addLog('Iniciando cadastro de novo empreendimento...', 'info');

    // Coleta dados do formul√°rio
    const nome = document.getElementById('nome').value.trim();
    const bairro = document.getElementById('bairro').value.trim();
    const descricao = document.getElementById('descricao').value.trim();

    addLog(`Nome: ${nome}`, 'info');
    addLog(`Bairro: ${bairro}`, 'info');

    // Valida nome √∫nico (delegado ao servidor)
    addLog('Valida√ß√£o de nome ser√° feita no servidor', 'info');

    // Coleta tipologias selecionadas
    const tipologiaCheckboxes = document.querySelectorAll('#tipologiaGroup input[type="checkbox"]:checked');
    const tipologia = Array.from(tipologiaCheckboxes).map(cb => cb.value);

    if (tipologia.length === 0) {
      addLog('‚ö†Ô∏è Nenhuma tipologia selecionada', 'warning');
      showResult('‚ö†Ô∏è Selecione pelo menos uma tipologia.', 'warning');
      return;
    }
    addLog(`Tipologias: ${tipologia.join(', ')}`, 'info');

    // Coleta perfis selecionados
    const perfilCheckboxes = document.querySelectorAll('#perfilGroup input[type="checkbox"]:checked');
    const perfil = Array.from(perfilCheckboxes).map(cb => cb.value);

    if (perfil.length === 0) {
      addLog('‚ö†Ô∏è Nenhum perfil selecionado', 'warning');
      showResult('‚ö†Ô∏è Selecione pelo menos um perfil.', 'warning');
      return;
    }
    addLog(`Perfis: ${perfil.join(', ')}`, 'info');

    // Define entrega
    const entrega = entregaCheck.checked ? 'Entregue' : entregaAno.value.trim() || 'A confirmar';
    addLog(`Entrega: ${entrega}`, 'info');

    // Monta objeto do novo empreendimento
    const novoEmpreendimento = {
      nome,
      bairro,
      tipologia,
      perfil,
      descricao,
      entrega
    };

    // Salva no backend
    try {
      const apiBase = (apiBaseInput.value || DEFAULT_API_BASE).replace(/\/$/, '');
      if (apiBase) localStorage.setItem('admin_api_base', apiBase);
      
      const token = 'heroia_app_admin'; // Token admin padr√£o

      addLog('Enviando para o servidor...', 'info');
      addLog(`URL: ${apiBase}/admin/empreendimento`, 'info');

      const response = await fetch(`${apiBase}/admin/empreendimento`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          ...novoEmpreendimento,
          token
        })
      });

      addLog(`Status HTTP: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

      const data = await response.json();

      if (!response.ok) {
        if (response.status === 409) {
          addLog('‚ö†Ô∏è Empreendimento duplicado no servidor', 'warning');
          showResult('‚ö†Ô∏è J√° existe um empreendimento com este nome no servidor.', 'warning');
        } else if (response.status === 403) {
          addLog('‚ùå Acesso negado - token inv√°lido', 'error');
          showResult('‚ùå Erro de autentica√ß√£o. Token inv√°lido.', 'error');
        } else {
          addLog(`‚ùå Erro: ${data.error || 'Erro desconhecido'}`, 'error');
          throw new Error(data.error || 'Erro ao salvar empreendimento');
        }
        return;
      }

      console.log('Empreendimento salvo:', data);
      addLog('‚úì Empreendimento cadastrado com sucesso!', 'success');
      addLog('‚úì Arquivo empreendimentos.json atualizado no servidor', 'success');
      addLog('Cadastro conclu√≠do com sucesso!', 'success');
      showResult('‚úÖ Empreendimento adicionado com sucesso!', 'success');
      
      // Limpa o formul√°rio ap√≥s 2 segundos
      setTimeout(() => {
        document.getElementById('empreendimentoForm').reset();
        // Restaura checkboxes de perfil marcados
        document.getElementById('perfil_moradia').checked = true;
        document.getElementById('perfil_investimento').checked = true;
        addLog('Formul√°rio limpo e pronto para novo cadastro', 'info');
      }, 2000);
      
    } catch (error) {
      console.error('Erro ao salvar:', error);
      addLog(`‚ùå ERRO ao adicionar empreendimento: ${error.message}`, 'error');
      addLog('Detalhes: Verifique se o servidor est√° online e acess√≠vel', 'error');
      showResult(`‚ùå Erro ao adicionar empreendimento: ${error.message}`, 'error');
    }
  });
</script>

</body>
</html>
